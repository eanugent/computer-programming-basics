<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>Fun Blocks</title>
		<meta name="description" content="Fun Blocks" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	</head>

	<body>
		<h1>Fun Blocks</h1>
		<div class="game-container">
			<div class="game-canvas">
				<canvas id="playarea" width="450" height="450">
					Canvas elements are required (2d context).
				</canvas>
			</div>
			<div class="game-info">
				<p>Score: <span id="score"></span></p>
				<p>High Score: <span id="highScore"></span></p>
				<p>Level: <span id="level"></span></p>
				<h2 id="gameover">&nbsp;</h2>
			</div>
		</div>

		<style>
			canvas#playarea {
				border: solid 0.3em;
				border-color: yellow;
			}

			body {
				background: #1E1F21;
				color: #EEEFF1;
			}

			:link {
				color: #BAD7FF;
			}

			:visited {
				color: #F6BAFF;
			}

			.game-container {
				display: flex;
				margin: auto;
			}

			.game-canvas {
				flex: 1;
			}

			.game-info {
				flex: 2;
				margin-left: 15px;
			}
		</style>

		<script>
			function initializeSettings() {
				funBlocks.screenWidth = 450;
				funBlocks.screenHeight = 450;
				funBlocks.avatarWidth = 50;
				funBlocks.avatarHeight = 50;
				funBlocks.blockWidth = 50;
				funBlocks.blockHeight = 50;
				funBlocks.playWidth = funBlocks.screenWidth - funBlocks.avatarWidth;
				funBlocks.playHeight = funBlocks.screenHeight - funBlocks.avatarHeight;
				funBlocks.blockColor = 'red';
				funBlocks.avatarColor = 'blue';
				funBlocks.levelLengthSeconds = 6 * 1000;

				funBlocks.highScore = 0;
			}

			function initializeAvatar() {
				funBlocks.avatar = {
					x: 0,
					y: funBlocks.playHeight,
					xinc: 0,
					w: funBlocks.avatarWidth,
					h: funBlocks.avatarHeight,
					inc: 10,
					dec: -10,
				};
			}

			function initialize() {
				initializeSettings();
				initializeAvatar();

				let canvas = document.querySelector('#playarea');
				funBlocks.context = canvas.getContext('2d');

				document.addEventListener('keydown', (e) => keyDown(e));
				document.addEventListener('keyup', (e) => keyUp(e));

				newGame();
			}

			function initializeBlockTimeout() {
				if (funBlocks.addBlockTimeout)
					window.clearTimeout(funBlocks.addBlockTimeout);

				funBlocks.addBlockTimeout = window.setTimeout(() => addBlock(), 1000);
			}

			function initializeLevelInterval() {
				if (funBlocks.levelInterval)
					window.clearInterval(funBlocks.levelInterval);

				funBlocks.levelInterval = window.setInterval(() => {
					funBlocks.level = funBlocks.level + 1;
				}, funBlocks.levelLengthSeconds);
			}

			function newGame() {
				document.querySelector('#gameover').innerHTML = '&nbsp;';

				funBlocks.context.clearRect(0, 0, funBlocks.screenWidth, funBlocks.screenHeight);
				funBlocks.avatar.x = 0;
				funBlocks.avatar.y = funBlocks.playHeight;
				funBlocks.blocks = [];
				funBlocks.level = 1;
				funBlocks.score = 0;
				document.querySelector('#score').innerHTML = funBlocks.score;

				funBlocks.running = true;

				initializeBlockTimeout();
				initializeLevelInterval();

				window.requestAnimationFrame(() => render());
			}

			function generateNewBlock(x) {
				return {
					x: x,
					y: 0,
					yinc: 0,
					w: funBlocks.blockWidth,
					h: funBlocks.blockHeight,
					inc: 10
				}
			}

			function addBlock() {
				if (!funBlocks.running)
					return;

				let newBlockX = Math.floor(Math.random() * funBlocks.playWidth);
				let newBlock = generateNewBlock(newBlockX);
				funBlocks.blocks.push(newBlock);
				let time = 1066 - (66 * funBlocks.level);
				time = Math.max(100, time);
				funBlocks.addBlockTimeout = window.setTimeout(() => addBlock(), time);
			}

			function render() {
				if (!funBlocks.running)
					return;

				// Clear old player avatar
				funBlocks.context.clearRect(funBlocks.avatar.x, funBlocks.avatar.y, funBlocks.avatar.w, funBlocks.avatar.h);
				// Set new x value
				funBlocks.avatar.x += funBlocks.avatar.xinc;

				// Can't be off the screen
				funBlocks.avatar.x = Math.min(funBlocks.playWidth, funBlocks.avatar.x);
				funBlocks.avatar.x = Math.max(0, funBlocks.avatar.x);

				drawAvatar();

				// Draw existing blocks
				for (let i = 0; i < funBlocks.blocks.length; i++) {
					let block = funBlocks.blocks[i];
					funBlocks.context.clearRect(block.x, block.y, block.w, block.h);
					block.y += block.inc;
					if (block.y <= funBlocks.playHeight) {
						funBlocks.context.fillStyle = funBlocks.blockColor;
						funBlocks.context.fillRect(block.x, block.y, block.w, block.h);
					}

					// Collision between block and avatar
					if (funBlocks.avatar.y < block.y + block.h
						&& block.y <= funBlocks.playHeight
						&& !(funBlocks.avatar.x > block.x + block.w
							|| funBlocks.avatar.x + funBlocks.avatar.w < block.x)) {
						funBlocks.running = false;
						document.querySelector('#gameover').innerHTML = 'Game Over';
						if (funBlocks.score > funBlocks.highScore) {
							funBlocks.highScore = funBlocks.score;
							document.querySelector('#highScore').innerHTML = funBlocks.highScore;
						}
						return;
					}
				}

				// Blocks that hit the ground
				while (funBlocks.blocks.length > 0 && funBlocks.blocks[0].y > funBlocks.playHeight) {
					funBlocks.score = funBlocks.score + 1;
					funBlocks.blocks.shift();
					document.querySelector('#score').innerHTML = funBlocks.score;
				}

				document.querySelector('#level').innerHTML = funBlocks.level;
				window.requestAnimationFrame(() => render());
			}

			function drawAvatar() {
				funBlocks.context.fillStyle = funBlocks.avatarColor;
				funBlocks.context.fillRect(
					funBlocks.avatar.x,
					funBlocks.avatar.y,
					funBlocks.avatar.w,
					funBlocks.avatar.h
				);
			}

			function keyDown(ev) {
				if (ev.defaultPrevented)
					return;

				const key = ev.key;
				switch (key) {
					case 'ArrowRight':
						funBlocks.avatar.xinc = funBlocks.avatar.inc;
						break;
					case 'ArrowLeft':
						funBlocks.avatar.xinc = funBlocks.avatar.dec;
						break;
					case ' ':
						if (!funBlocks.running)
							newGame();
						break;
					default:
						return;
				}

				ev.preventDefault();
			}

			function keyUp(ev) {
				if (ev.defaultPrevented)
					return;

				const key = ev.key;

				switch (key) {
					case 'ArrowRight':
						if (funBlocks.avatar.xinc == funBlocks.avatar.inc)
							funBlocks.avatar.xinc = 0;
						break;
					case 'ArrowLeft':
						if (funBlocks.avatar.xinc == funBlocks.avatar.dec)
							funBlocks.avatar.xinc = 0;
						break;
					default:
						return;
				}

				ev.preventDefault();
			}

			const funBlocks = {};
			window.onload = function () {
				initialize();
			}
		</script>
	</body>

</html>